name: Security
on:
  workflow_call:
    inputs:
      SEMGREP_MANDATORY:
        description: 'Run semgrep as mandatory or not'
        default: 'true'
        required: false
        type: string
      RUNNER_NAME:
        description: 'Github runner name'
        default: 'self-hosted'
        required: true
        type: string
    secrets:
      SEMGREP_APP_TOKEN:
        description: 'needed for semgrep'
        required: true

jobs:
  semgrep:
    name: Semgrep
    runs-on: [ 'k8s-runner',  '${{ inputs.RUNNER_NAME }}' ]
    container:
      image: returntocorp/semgrep
    steps:
      - uses: actions/checkout@v4.0.0
      - name: Run semgrep
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  # semgrep-with-audit:
  #   name: Semgrep non mandatory
  #   runs-on: [ 'self-hosted', '${{ inputs.RUNNER_NAME }}' ]
  #   if: ${{ inputs.SEMGREP_MANDATORY != 'true' }}
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: returntocorp/semgrep-action@v1
  #       with:
  #         auditOn: push
  #         publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
  #         publishDeployment: 339
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
